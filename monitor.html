<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麻醉監控助手 Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgDark: '#0f172a', // 深藍背景
                        panelDark: '#1e293b', // 面板顏色
                        accentGreen: '#4ade80', // 心跳綠
                        accentBlue: '#60a5fa', // 呼吸藍
                        accentYellow: '#facc15', // 血氧黃
                        accentPurple: '#a78bfa', // 二氧化碳紫
                        accentRed: '#f87171' // 警告/退出
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
            /* 防止手機下拉刷新影響操作 */
            overscroll-behavior: none;
        }
        /* 數字字體風格 */
        .digital-font {
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: -1px;
        }
        /* 隱藏滾動條但保留功能 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 手機按鈕點擊效果 */
        .btn-active:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden select-none">

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="handleFileImport(this)">

    <div id="setupScreen" class="flex flex-col items-center justify-center h-full px-4 relative z-10">
        
        <div class="absolute top-6 right-6">
            <button onclick="document.getElementById('fileInput').click()" class="text-slate-400 hover:text-white border border-slate-600 px-4 py-2 rounded-full text-sm flex items-center transition-colors bg-slate-800 shadow-lg">
                <i class="fa-solid fa-folder-open mr-2"></i> 讀取舊檔
            </button>
        </div>

        <div class="bg-panelDark p-6 rounded-3xl shadow-2xl w-full max-w-md border border-slate-700">
            <div class="text-center mb-6">
                <div class="bg-slate-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 border border-slate-600">
                    <i class="fa-solid fa-user-doctor text-3xl text-accentBlue"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-wide">麻醉監控設定</h1>
                <p class="text-slate-400 text-xs">輸入體重以自動計算誘導劑量</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 font-bold mb-1 ml-1">病歷號碼</label>
                    <input type="text" id="caseNo" class="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-white text-lg focus:border-accentBlue outline-none" placeholder="例如: 112001">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 font-bold mb-1 ml-1">寵物名</label>
                        <input type="text" id="pName" class="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-white text-lg focus:border-accentBlue outline-none" placeholder="名字">
                    </div>
                    <div>
                        <label class="block text-xs text-accentYellow font-bold mb-1 ml-1">體重 (kg)</label>
                        <input type="number" id="pWeight" oninput="calculateDrugs()" class="w-full bg-slate-800 border border-accentYellow/50 rounded-xl px-4 py-3 text-white text-xl font-bold focus:border-accentYellow outline-none" placeholder="0.0">
                    </div>
                </div>

                <div class="bg-slate-800/80 p-4 rounded-xl border border-dashed border-slate-600 mt-2">
                    <h3 class="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">建議劑量參考</h3>
                    <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                        <span class="text-sm text-slate-300">Propofol (2mg/kg)</span>
                        <span id="calcPropofol" class="text-accentGreen font-bold text-lg">0 mg</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-300">Dexdomitor (1mcg/kg)</span>
                        <span id="calcDex" class="text-accentBlue font-bold text-lg">0 mcg</span>
                    </div>
                </div>

                <button onclick="startMonitoring()" class="btn-active w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/50 mt-2 text-lg flex items-center justify-center">
                    開始監控 <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="dashboardScreen" class="hidden flex-col h-full bg-bgDark">
        
        <div class="bg-panelDark border-b border-slate-700 p-3 flex justify-between items-center shadow-md z-20">
            <div class="flex flex-col">
                <h2 id="dispName" class="font-bold text-lg text-white leading-tight">寵物名</h2>
                <span id="dispInfo" class="text-xs text-slate-400">#0000 | 0kg</span>
            </div>
            <div class="flex gap-2">
                <button onclick="exportData()" class="btn-active bg-emerald-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center shadow">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> 存檔
                </button>
                <button onclick="resetApp()" class="btn-active bg-slate-700 text-red-300 border border-slate-600 px-3 py-2 rounded-lg text-xs">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 p-2 bg-black/20 shrink-0">
            <div class="bg-slate-800 rounded-xl p-2 pl-3 border-l-4 border-accentGreen relative overflow-hidden">
                <i class="fa-solid fa-heart text-slate-700 absolute right-2 top-2 text-4xl opacity-20"></i>
                <div class="text-xs text-slate-400 font-bold">心率 HR</div>
                <div id="liveHR" class="text-4xl font-bold digital-font text-accentGreen tracking-tighter">--</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-2 pl-3 border-l-4 border-white relative overflow-hidden">
                <div class="text-xs text-slate-400 font-bold">血壓 MAP</div>
                <div class="flex items-baseline">
                    <span id="liveMap" class="text-4xl font-bold digital-font text-blue-200 tracking-tighter">--</span>
                    <span class="text-xs text-slate-500 ml-1 block">
                        <span id="liveSys">--</span>/<span id="liveDia">--</span>
                    </span>
                </div>
            </div>
            <div class="bg-slate-800 rounded-xl p-2 pl-3 border-l-4 border-accentBlue relative overflow-hidden">
                <i class="fa-solid fa-lungs text-slate-700 absolute right-2 top-2 text-4xl opacity-20"></i>
                <div class="text-xs text-slate-400 font-bold">呼吸 RR</div>
                <div id="liveRR" class="text-4xl font-bold digital-font text-accentBlue tracking-tighter">--</div>
            </div>
            <div class="bg-slate-800 rounded-xl p-2 pl-3 border-l-4 border-accentYellow relative overflow-hidden">
                <div class="text-xs text-slate-400 font-bold">血氧 SpO2</div>
                <div id="liveSpo2" class="text-4xl font-bold digital-font text-accentYellow tracking-tighter">--</div>
            </div>
        </div>

        <div class="flex-1 p-2 relative min-h-0 w-full">
            <div class="h-full w-full bg-slate-800/40 rounded-xl border border-slate-700/50 p-2 relative backdrop-blur-sm">
                <canvas id="vitalsChart"></canvas>
            </div>
        </div>

        <div class="h-40 bg-panelDark border-t border-slate-700 flex flex-col shrink-0">
            <div class="px-4 py-2 bg-slate-800 text-xs font-bold text-slate-400 flex justify-between items-center shadow-sm z-10">
                <span><i class="fa-solid fa-list-ul mr-1"></i> 紀錄流水帳</span>
                <span class="bg-slate-900 px-2 py-0.5 rounded text-emerald-400 font-mono" id="timer">00:00</span>
            </div>
            <div id="eventList" class="flex-1 overflow-y-auto p-2 space-y-2 hide-scrollbar text-sm pb-4">
                </div>
        </div>

        <div class="bg-panelDark p-3 grid grid-cols-2 gap-3 border-t border-slate-700 pb-8 shadow-[0_-5px_15px_rgba(0,0,0,0.3)] z-30">
            <button onclick="openRecordModal()" class="btn-active bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg flex flex-col items-center justify-center border-t border-indigo-500">
                <i class="fa-solid fa-pen-to-square text-2xl mb-1"></i>
                <span>紀錄數值</span>
            </button>
            <button onclick="addBolusEvent()" class="btn-active bg-slate-700 text-white font-bold py-4 rounded-2xl shadow-lg flex flex-col items-center justify-center border border-slate-600">
                <i class="fa-solid fa-syringe text-2xl mb-1 text-accentPurple"></i>
                <span>追加/事件</span>
            </button>
        </div>
    </div>

    <div id="recordModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-panelDark w-full max-w-lg rounded-t-3xl sm:rounded-3xl border-t sm:border border-slate-600 p-5 shadow-2xl animate-slide-up">
            
            <div class="flex justify-between items-center mb-5 border-b border-slate-700 pb-3">
                <h3 class="text-white font-bold text-lg"><i class="fa-regular fa-clock mr-2"></i>5分鐘紀錄</h3>
                <button onclick="closeRecordModal()" class="w-8 h-8 rounded-full bg-slate-700 text-slate-300 flex items-center justify-center hover:bg-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-4">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">時間</label>
                    <input id="inputTime" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white text-center font-mono" readonly>
                </div>
                <div class="col-span-2">
                    <label class="text-xs text-slate-400 block mb-1">輸液速度 (ml/hr)</label>
                    <input type="number" id="inputFluids" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white text-lg font-bold focus:border-blue-500 outline-none" value="10">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-4">
                <div>
                    <label class="text-xs text-accentGreen block mb-1 font-bold text-center">HR 心跳</label>
                    <input type="number" id="inputHR" class="w-full bg-slate-800 border border-accentGreen/50 rounded-xl p-3 text-2xl font-bold text-white text-center focus:bg-slate-700 outline-none" placeholder="--">
                </div>
                <div>
                    <label class="text-xs text-accentBlue block mb-1 font-bold text-center">RR 呼吸</label>
                    <input type="number" id="inputRR" class="w-full bg-slate-800 border border-accentBlue/50 rounded-xl p-3 text-2xl font-bold text-white text-center focus:bg-slate-700 outline-none" placeholder="--">
                </div>
                <div>
                    <label class="text-xs text-accentYellow block mb-1 font-bold text-center">SpO2</label>
                    <input type="number" id="inputSpO2" class="w-full bg-slate-800 border border-accentYellow/50 rounded-xl p-3 text-2xl font-bold text-white text-center focus:bg-slate-700 outline-none" value="98">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <div>
                    <label class="text-xs text-slate-400 block mb-1 text-center">SYS 收縮</label>
                    <input type="number" id="inputSys" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-white text-center font-bold" placeholder="120">
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1 text-center">DIA 舒張</label>
                    <input type="number" id="inputDia" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-white text-center font-bold" placeholder="80">
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1 text-center">Iso/Sevo %</label>
                    <input type="number" id="inputIso" step="0.1" class="w-full bg-slate-900 border border-slate-500 rounded-lg p-2 text-white text-center font-bold text-lg" value="2.0">
                </div>
            </div>

            <button onclick="saveRecord()" class="btn-active w-full bg-accentGreen text-slate-900 font-bold py-4 rounded-xl text-lg shadow-lg shadow-green-900/50">
                確認儲存
            </button>
            <div class="h-4"></div> </div>
    </div>

    <script>
        // 全局變數
        let chartInstance = null;
        let caseData = { startTime: null, records: [], info: {} };
        let timerInterval;

        // 1. 頁面載入時檢查舊資料
        window.onload = function() {
            const saved = localStorage.getItem('vetMonitorData_TW');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if(parsed && parsed.info) {
                        caseData = parsed;
                        // 填充基本資料
                        document.getElementById('caseNo').value = caseData.info.caseNo || '';
                        document.getElementById('pName').value = caseData.info.name || '';
                        document.getElementById('pWeight').value = caseData.info.weight || '';
                        calculateDrugs();
                    }
                } catch(e) { console.error("讀取錯誤", e); }
            }
        };

        // 2. 自動計算藥物
        function calculateDrugs() {
            const w = parseFloat(document.getElementById('pWeight').value) || 0;
            document.getElementById('calcPropofol').innerText = (w * 2).toFixed(1) + " mg";
            document.getElementById('calcDex').innerText = (w * 1).toFixed(1) + " mcg";
        }

        // 3. 開始監控
        function startMonitoring() {
            if(!caseData.startTime) { // 如果是新案件
                const w = document.getElementById('pWeight').value;
                if (!w) { alert("請輸入體重！"); return; }
                
                caseData.info = {
                    caseNo: document.getElementById('caseNo').value || '無編號',
                    name: document.getElementById('pName').value || '未命名',
                    weight: w,
                    date: new Date().toISOString().split('T')[0]
                };
                caseData.startTime = new Date().getTime();
            }
            
            initDashboard();
            saveToLocal();
        }

        // 4. 初始化儀表板
        function initDashboard() {
            // 切換畫面
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('flex');
            
            // 更新頂部資訊
            document.getElementById('dispName').innerText = caseData.info.name;
            document.getElementById('dispInfo').innerText = `#${caseData.info.caseNo} | ${caseData.info.weight}kg`;

            // 初始化圖表
            initChart();
            
            // 恢復數據與列表
            document.getElementById('eventList').innerHTML = ''; 
            if(caseData.records.length > 0) {
                caseData.records.forEach(rec => {
                    if(rec.type === 'vitals') {
                        addPointToChart(rec.timeLabel, rec.hr, rec.map);
                        updateBigNumbers(rec);
                    }
                    addLogEntry(rec);
                });
            } else {
                addLogEntry({timeLabel: getCurrentTime(), type: 'event', note: '麻醉開始 (Induction)'});
            }

            // 啟動計時器
            if(!timerInterval) timerInterval = setInterval(updateTimer, 1000);
        }

        // 5. 圖表設定 (Chart.js)
        function initChart() {
            if(chartInstance) { chartInstance.destroy(); }
            const ctx = document.getElementById('vitalsChart').getContext('2d');
            
            // 漸層效果
            let gradientHR = ctx.createLinearGradient(0, 0, 0, 300);
            gradientHR.addColorStop(0, 'rgba(74, 222, 128, 0.4)');
            gradientHR.addColorStop(1, 'rgba(74, 222, 128, 0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { 
                            label: '心率 HR', 
                            data: [], 
                            borderColor: '#4ade80', // 綠色
                            backgroundColor: gradientHR,
                            fill: true, 
                            tension: 0.4,
                            pointRadius: 3,
                            borderWidth: 2
                        },
                        { 
                            label: '平均血壓 MAP', 
                            data: [], 
                            borderColor: '#60a5fa', // 藍色
                            borderDash: [5,5], 
                            tension: 0.4,
                            pointRadius: 3,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false, // 關鍵：讓圖表適應 Div 大小
                    plugins: {
                        legend: { labels: { color: '#94a3b8', font: {size: 10} } }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 200, 
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', font: {size: 10} } 
                        }, 
                        x: { 
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', maxTicksLimit: 6, font: {size: 10} }
                        } 
                    }
                }
            });
        }

        function addPointToChart(label, hr, map) {
            if(!chartInstance) return;
            chartInstance.data.labels.push(label);
            chartInstance.data.datasets[0].data.push(hr);
            chartInstance.data.datasets[1].data.push(map);
            chartInstance.update();
        }

        // 6. 存檔與讀檔功能
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(caseData));
            const downloadAnchorNode = document.createElement('a');
            const fileName = `Case_${caseData.info.caseNo}_${caseData.info.name}.json`;
            
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if(loadedData.info && loadedData.records) {
                        if(confirm("確定要載入這個舊檔案嗎？當前的紀錄將會被覆蓋。")) {
                            caseData = loadedData;
                            saveToLocal(); 
                            
                            // 刷新頁面邏輯
                            document.getElementById('caseNo').value = caseData.info.caseNo;
                            document.getElementById('pName').value = caseData.info.name;
                            document.getElementById('pWeight').value = caseData.info.weight;
                            calculateDrugs();
                            
                            if(!document.getElementById('dashboardScreen').classList.contains('hidden')) {
                                 initDashboard();
                            } else {
                                alert("檔案讀取成功！請點擊「開始監控」查看。");
                            }
                        }
                    } else {
                        alert("檔案格式錯誤。");
                    }
                } catch(err) {
                    alert("讀取失敗: " + err);
                }
            };
            reader.readAsText(file);
        }

        // 7. 輔助功能 (時間、彈窗、儲存邏輯)
        function getCurrentTime() {
            const d = new Date();
            return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }

        function updateTimer() {
            if(!caseData.startTime) return;
            const diff = Math.floor((new Date().getTime() - caseData.startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }

        function openRecordModal() {
            document.getElementById('recordModal').classList.remove('hidden');
            document.getElementById('inputTime').value = getCurrentTime();
            // 自動填入上一次的 Fluid Rate 和 Iso
            const lastRec = caseData.records.slice().reverse().find(r => r.type === 'vitals');
            if(lastRec) {
                document.getElementById('inputFluids').value = lastRec.fluids || 10;
                document.getElementById('inputIso').value = lastRec.iso || 2.0;
            }
        }
        function closeRecordModal() { document.getElementById('recordModal').classList.add('hidden'); }

        function saveRecord() {
            const time = document.getElementById('inputTime').value;
            const fluids = document.getElementById('inputFluids').value;
            const hr = parseInt(document.getElementById('inputHR').value) || 0;
            const rr = parseInt(document.getElementById('inputRR').value) || 0;
            const sys = parseInt(document.getElementById('inputSys').value) || 0;
            const dia = parseInt(document.getElementById('inputDia').value) || 0;
            const spo2 = parseInt(document.getElementById('inputSpO2').value) || 0;
            const iso = document.getElementById('inputIso').value;
            
            // 計算平均血壓 MAP = (Sys + 2*Dia) / 3
            let map = (sys > 0 && dia > 0) ? Math.round((sys + 2*dia)/3) : 0;

            const rec = { 
                type: 'vitals', 
                timeLabel: time, 
                hr, rr, sys, dia, map, spo2, iso, fluids 
            };
            
            caseData.records.push(rec);
            saveToLocal();
            
            addPointToChart(time, hr, map);
            updateBigNumbers(rec);
            addLogEntry(rec);
            closeRecordModal();
        }

        function updateBigNumbers(rec) {
            if(rec.hr) document.getElementById('liveHR').innerText = rec.hr;
            if(rec.rr) document.getElementById('liveRR').innerText = rec.rr;
            if(rec.spo2) document.getElementById('liveSpo2').innerText = rec.spo2;
            if(rec.sys) {
                document.getElementById('liveSys').innerText = rec.sys;
                document.getElementById('liveDia').innerText = rec.dia;
                document.getElementById('liveMap').innerText = rec.map;
            }
        }

        function addBolusEvent() {
            const drug = prompt("請輸入藥物名稱或事件 (例如: Fentanyl 1ml):", "");
            if(drug) {
                const rec = { type: 'event', timeLabel: getCurrentTime(), note: drug };
                caseData.records.push(rec);
                saveToLocal();
                addLogEntry(rec);
            }
        }

        function addLogEntry(rec) {
            const list = document.getElementById('eventList');
            const div = document.createElement('div');
            
            if (rec.type === 'event') {
                div.className = "text-slate-300 bg-slate-800 p-3 rounded-lg text-sm border-l-4 border-accentPurple mb-2 shadow-sm";
                div.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa-solid fa-tag mr-2 text-accentPurple"></i>
                        <span class="font-mono font-bold mr-2">${rec.timeLabel}</span> 
                        <span>${rec.note}</span>
                    </div>`;
            } else {
                div.className = "flex justify-between items-center text-slate-300 bg-slate-800/30 p-2 rounded border border-slate-700/50 mb-1 text-xs sm:text-sm";
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="font-mono font-bold text-accentGreen">${rec.timeLabel}</span>
                        <span class="text-white"><span class="text-slate-500">HR:</span>${rec.hr}</span>
                        <span class="text-white"><span class="text-slate-500">BP:</span>${rec.sys}/${rec.dia}</span>
                        <span class="text-accentYellow"><span class="text-slate-500">SpO2:</span>${rec.spo2}%</span>
                    </div>
                    <div class="text-slate-400 font-mono">Iso:${rec.iso}%</div>
                `;
            }
            list.prepend(div); // 新的在最上面
        }

        function saveToLocal() { localStorage.setItem('vetMonitorData_TW', JSON.stringify(caseData)); }
        
        function resetApp() { 
            if(confirm("確定要結束此病例嗎？\n建議先點擊「存檔」下載紀錄。\n確定結束將會清除所有數據。")) {
                localStorage.removeItem('vetMonitorData_TW'); 
                location.reload(); 
            } 
        }
    </script>
</body>
</html>
